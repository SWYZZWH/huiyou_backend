# 后端开发文档

### Update 2020/10/17 by zwh

eclipse 源码中中文注释乱码问题：

![](https://i.imgur.com/7p2rhay.png)





### Update 2020/10/14 by zwh

推荐链的初步构思

- 产品形态：前端发送一个请求，后端返回下一个推荐的视频（类似网易云私人FM）
- 首先需要建一张新表，为视频top榜，首先这张表至少有两个字段，bv号+分数，这个分数需要后端根据某些规则动态更新
- 这张表还应该有播放量字段，当一个视频的播放量较高时，将其归档，不再推荐给其他用户。可以考虑在top榜表中增加一个字段表示是否已归档（也可以直接根据分数大小判定，但新增字段较好，方便记录归档视频的后续情况）。
- 前端需要监听用户对某个视频的反馈，如是否点赞，收藏，分享，评论等，并给后端发送更新请求。后端需要接收请求，并根据一系列规则计算出视频新的分数，并更新top榜。
- 当前端发送获取下一个推荐视频请求时，从top榜中根据一定规则选出一个视频，返回给前端bv号

整理

- 增加一张表，包含3-4个或更多字段，并提供对应的CRUD操作
- 处理两种新请求（更新top榜请求+获取下一个推荐视频请求），向前端提供对应api

问题

- top榜表的存储最好是按分数高低有序存储的，这样能方便检索，MongoDB是否有办法指定存储方式？
- 冷启动问题，刚上线的时候top榜为空的问题？



### Update 2020/10/11 by zwh

利用Github Action实现自动化部署

- Github Action其实就是一个触发式的云服务器

- 由于有store，可以方便的调用其他开发者贡献的Actions（实际上每个Action就是Github上一个Repository）

- 使用[ssh deploy](https://github.com/marketplace/actions/ssh-deploy) 这个Action，可以与腾讯云服务器建立SSH链接，然后每当有了新的push时，将执行这个Action，将当前项目中的指定文件（最终生成的.jar包）上传到服务器，这样就避免了每次生成新的包以后都要手动上传

- 配置时要注意，需要在腾讯云服务器上生成SSH密钥对，将**公钥**添加到腾讯云服务器的Auth_keys，将**私钥**存到Github项目的Secrets中。

- 更进一步，通过Action，上传项目包后通过脚本自动启动服务

- 使用appleboy/ssh-action@v0.1.3 这个Action，配置几乎同上

- script的值是要运行的脚本：

  ```
  script: |
  	# kill previous service
      sudo kill -9 $(lsof -i:8080 -t)
      cd /usr/local/huiyou-backend
      java -jar demo-0.0.1-SNAPSHOT.jar &
      disown
  ```

- 一点缺陷：执行该脚本后Action无法自动结束，需要手动终止



### Update 2020/10/10 by zwh

设置服务为守护进程，避免退出SSH后自动结束进程

- SSH启动的服务实际上默认是前台进程，前台进程在退出SSH后就会自动结束

- 首先将服务设置为后台，有两种方法：

  - 对于运行中的进程，可以先按`ctrl + z`，然后执行`bg`命令
  - 对于未启动的进程，直接在命令后加&即可

- 一般来说设置为后台即可解决问题，但并不100%保险，可以在设置为后台进程后运行命令

  ```
  disown
  ```

  会将启动的进程移除后台进程队列，这样可以确保其不会在控制台退出后被结束

